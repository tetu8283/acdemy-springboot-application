<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.springbootapplication.mapper.LearningDataMapper">

    <!-- 学習データの結果マッピング -->
    <resultMap id="LearningDataResultMap" type="com.spring.springbootapplication.entity.LearningData">
        <id column="learning_id" property="learningId" />
        <result column="user_id" property="userId" />
        <result column="category_id" property="categoryId" />
        <result column="learning_year" property="learningYear" />
        <result column="learning_month" property="learningMonth" />
        <result column="learning_time" property="learningTime" />
    </resultMap>

    <!-- 学習データを挿入 -->
    <insert id="insertLearningData" parameterType="com.spring.springbootapplication.entity.LearningData" useGeneratedKeys="true" keyProperty="learningId">
        INSERT INTO learning_data(user_id, category_id, learning_year, learning_month, learning_time) 
        VALUES(#{userId}, #{categoryId}, #{learningYear}, #{learningMonth}, #{learningTime})
    </insert>

    <!-- 学習データを取得 -->
    <select id="findByUserId" parameterType="Integer" resultMap="LearningDataResultMap">
        SELECT * FROM learning_data WHERE user_id = #{userId}
    </select>

    <select id="findByUserIdAndCategoryIdAndYearAndMonth" parameterType="map" resultMap="LearningDataResultMap">
        SELECT * FROM learning_data 
        WHERE user_id = #{userId} 
        AND category_id = #{categoryId} 
        AND learning_year = #{learningYear} 
        AND learning_month = #{learningMonth}
    </select>

    <!-- 学習データを更新 -->
    <update id="updateLearningData" parameterType="com.spring.springbootapplication.entity.LearningData">
        UPDATE learning_data
        SET learning_time = #{learningTime}
        WHERE learning_id = #{learningId} 
    </update>

    <!-- 学習データを削除 -->
    <delete id="deleteByCategoryIdAndUserId" parameterType="map">
        DELETE FROM learning_data 
        WHERE category_id = #{categoryId} 
        AND user_id = #{userId}
    </delete>

    <!-- カテゴリタイプごとの学習時間の合計を取得 -->
    <select id="getTotalLearningTimeByCategoryType" parameterType="map" resultType="map">
        SELECT c.category_type, SUM(ld.learning_time) AS total_learning_time
        FROM learning_data ld
        JOIN category c ON ld.category_id = c.category_id
        WHERE ld.user_id = #{userId}
            AND ld.learning_year = #{learningYear}
            AND ld.learning_month = #{learningMonth}
        GROUP BY c.category_type
        ORDER BY c.category_type;
    </select>

</mapper>
